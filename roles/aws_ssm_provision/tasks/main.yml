---
- name: Lookup latest Ubuntu 22.04 AMI from SSM Parameter Store
  amazon.aws.aws_ssm_parameter_store:
    name: "/aws/service/canonical/ubuntu/server/22.04/stable/current/amd64/hvm/ebs-gp2/ami-id"
    region: "{{ aws_region }}"
  register: ubuntu_ami

- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ name_prefix }}-{{ environment }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ aws_region }}"
    tags: "{{ tag_base | default({}) }}"
  register: vpc

- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    vpc_id: "{{ vpc.vpc.id }}"
    region: "{{ aws_region }}"
    state: present
    tags: "{{ tag_base | default({}) }}"
  register: igw

- name: Create public subnet
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc.vpc.id }}"
    cidr: "{{ public_subnet_cidr }}"
    az: "{{ aws_region }}a"
    region: "{{ aws_region }}"
    map_public: true
    tags: "{{ tag_base | default({}) | combine({'Name': name_prefix ~ '-' ~ environment ~ '-public-subnet'}) }}"
  register: subnet

- name: Create route table for public subnet
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc.vpc.id }}"
    region: "{{ aws_region }}"
    tags: "{{ tag_base | default({}) | combine({'Name': name_prefix ~ '-' ~ environment ~ '-public-rt'}) }}"
    subnets:
      - "{{ subnet.subnet.id }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ igw.gateway_id }}"
  register: rt

- name: Create security group (NO SSH)
  amazon.aws.ec2_security_group:
    name: "{{ name_prefix }}-{{ environment }}-sg"
    description: "Allow app ports (no SSH)"
    vpc_id: "{{ vpc.vpc.id }}"
    region: "{{ aws_region }}"
    rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: 0.0.0.0/0
      - proto: tcp
        from_port: 8080
        to_port: 8080
        cidr_ip: 0.0.0.0/0
    tags: "{{ tag_base | default({}) }}"
  register: sg

- name: Ensure IAM role for SSM exists
  amazon.aws.iam_role:
    name: "{{ name_prefix }}-{{ environment }}-ec2-ssm-role"
    state: present
    assume_role_policy_document: |
      {
        "Version": "2012-10-17",
        "Statement": [
          {
            "Effect": "Allow",
            "Principal": {"Service": "ec2.amazonaws.com"},
            "Action": "sts:AssumeRole"
          }
        ]
      }
  register: ssm_role

- name: Attach AmazonSSMManagedInstanceCore policy
  amazon.aws.iam_managed_policy:
    iam_type: role
    iam_name: "{{ name_prefix }}-{{ environment }}-ec2-ssm-role"
    policy_arn: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
    state: present

- name: Ensure instance profile exists
  amazon.aws.iam_instance_profile:
    name: "{{ name_prefix }}-{{ environment }}-instance-profile"
    state: present
    roles:
      - "{{ name_prefix }}-{{ environment }}-ec2-ssm-role"

- name: Launch EC2 instances
  amazon.aws.ec2_instance:
    name: "{{ name_prefix }}-{{ environment }}-app"
    region: "{{ aws_region }}"
    image_id: "{{ ubuntu_ami.value }}"
    instance_type: "{{ instance_type }}"
    network:
      subnet_id: "{{ subnet.subnet.id }}"
      assign_public_ip: true
      security_group_id: "{{ sg.group_id }}"
    iam_instance_profile: "{{ name_prefix }}-{{ environment }}-instance-profile"
    tags: "{{ tag_base | default({}) | combine({'Name': name_prefix ~ '-' ~ environment ~ '-app'}) }}"
    wait: true
    count: "{{ instance_count }}"
  register: ec2

- name: Show created instances
  ansible.builtin.debug:
    msg:
      - "VPC: {{ vpc.vpc.id }}"
      - "Instances: {{ ec2.instances | map(attribute='instance_id') | list }}"
      - "Public IPs: {{ ec2.instances | map(attribute='public_ip_address') | list }}"
