---
- name: Ensure bg root exists
  ansible.builtin.file:
    path: "{{ bg_root }}"
    state: directory
    mode: '0755'

- name: Copy bg stack files
  ansible.builtin.copy:
    src: "stacks/sample-webapp-bg/"
    dest: "{{ bg_root }}/"
    mode: '0644'

- name: Ensure ACTIVE file exists
  ansible.builtin.copy:
    dest: "{{ active_color_file }}"
    content: "blue\n"
    force: false

- name: Read active color
  ansible.builtin.slurp:
    src: "{{ active_color_file }}"
  register: active_raw

- name: Set active/inactive
  ansible.builtin.set_fact:
    active_color: "{{ (active_raw.content | b64decode).strip() }}"
    inactive_color: "{{ 'green' if ((active_raw.content | b64decode).strip() == 'blue') else 'blue' }}"

- name: Set ports
  ansible.builtin.set_fact:
    active_port: "{{ blue_port if active_color == 'blue' else green_port }}"
    inactive_port: "{{ green_port if active_color == 'blue' else blue_port }}"

# 1) inactive 스택을 최신으로 올림
- name: Compose up inactive stack
  community.docker.docker_compose_v2:
    project_src: "{{ bg_root }}"
    profiles:
      - "{{ inactive_color }}"
    state: present

# 2) inactive 헬스체크
- name: Healthcheck inactive
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ inactive_port }}{{ bg_health_path }}"
    status_code: 200
  register: hc_inactive
  retries: 30
  delay: 2
  until: hc_inactive.status == 200

# 3) nginx 업스트림 스위치 (active_backend_port 템플릿 렌더)
- name: Render nginx config to point new active
  ansible.builtin.template:
    src: nginx.conf.j2
    dest: "{{ bg_root }}/nginx.conf"
    mode: '0644'
  vars:
    active_backend_port: "{{ inactive_port }}"

# 4) nginx 컨테이너 reload
- name: Reload nginx container
  community.docker.docker_container_exec:
    container: sample-bg-nginx
    command: ["nginx", "-s", "reload"]
  register: nginx_reload
  failed_when: false

# 5) ACTIVE 전환 기록
- name: Switch ACTIVE
  ansible.builtin.copy:
    dest: "{{ active_color_file }}"
    content: "{{ inactive_color }}\n"

# 6) 이전 active 스택은 down(선택)
- name: Compose down old active stack (optional)
  community.docker.docker_compose_v2:
    project_src: "{{ bg_root }}"
    profiles:
      - "{{ active_color }}"
    state: absent
  when: (bg_keep_old | default(false)) | bool == false
